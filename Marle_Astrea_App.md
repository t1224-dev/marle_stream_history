# Claude Conversation

## Response:
 # マールの軌跡アプリ 設計書（最終版）

## 1. アプリケーション概要

**アプリ名**: マールの軌跡アプリ

**目的**: 引退したVtuber「マール・アストレア」の活動の軌跡を記録し、YouTubeの動画コンテンツをファンがアクセスしやすい形で提供する

**主要機能**:
- 活動カレンダー表示
- YouTube動画の整理と表示
- 検索・フィルタリング機能
- お気に入り登録機能
- 動画情報の共有機能

**対象プラットフォーム**: モバイル (iOS/Android)

**開発フレームワーク**: Flutter

**ブランド情報**:
- イメージカラー: 白、水色、薄紫色

## 2. 機能要件

### 2.1 必須機能

#### ホーム画面
- マール・アストレアのプロフィール表示
- 最近の活動ハイライト
- 各機能へのナビゲーション

#### カレンダー機能
- 月別/週別/日別表示切り替え
- 活動日のマーカー表示
- 日付選択による動画一覧表示
- 動画詳細表示

#### 検索機能
- キーワード検索
- 日付範囲フィルター
- タグ検索

#### YouTube動画詳細表示
- サムネイル表示
- タイトル、説明文
- 公開日時
- YouTube連携（外部アプリ起動）
- アーカイブURL表示（設定に依存）
- 共有機能（サムネイル画像とメッセージ）

#### お気に入り機能
- 動画のお気に入り登録
- お気に入り一覧表示

### 2.2 追加機能（優先度順）

#### 設定機能
- キャッシュ管理(ローカルデータベースのリセット機能)
- アプリ情報
- アーカイブ有効化トグル（隠し要素、デフォルトオフ）

#### カスタマイズ機能
- ユーザー独自タグ付け
- 表示レイアウト調整

## 3. 技術仕様

### 3.1 アーキテクチャ
- **アーキテクチャパターン**: MVVM または Clean Architecture
- **状態管理**: Provider または Riverpod
- **ディレクトリ構造**: 機能モジュール + レイヤー分離型

### 3.2 データ管理
- **ローカルデータベース**: SQLite (Drift または Floor を使用)
- **ファイル保存**: アプリの内部ストレージを使用
- **データモデル**:
  - YoutubeVideo
  - CalendarEvent
  - Tag
  - Favorite
  - AppSettings

### 3.3 データ入力方法
- **初期データ**:
  - Flutter アセット（assets/data/）に格納したJSONデータ
  - 初回起動時に自動的にローカルDBに展開

### 3.4 UI/UX設計
- **デザインシステム**: Material Design 3 をベースにカスタマイズ
- **テーマ**: マール・アストレアのイメージカラーに合わせた配色（白、水色、薄紫色）
- **主要UI要素**:
  - カスタムカレンダー
  - 動画カード
  - サムネイル表示グリッド
  - 検索フィルター

## 4. 画面フロー図

```
ホーム画面
  ├── カレンダー画面
  │     └── YouTube動画詳細画面
  ├── 検索画面
  │     └── YouTube動画詳細画面
  ├── お気に入り画面
  │     └── YouTube動画詳細画面
  └── 設定画面
        └── アーカイブ設定（隠し要素）
```

## 5. データモデル定義

### YoutubeVideo
- id: String
- videoId: String
- publishedAt: DateTime
- title: String
- thumbnailPath: String (内部ストレージ上の絶対パス)
- description: String
- videoUrl: String
- archiveUrl: String (アーカイブ用URL)
- isFavorite: bool
- tags: List<String>
- customNotes: String (ユーザーノート)

### CalendarEvent
- id: String
- date: DateTime
- videos: List<YoutubeVideo>

### Tag
- id: String
- name: String
- color: Color

### Favorite
- videoId: String
- addedAt: DateTime
- customNote: String

### AppSettings
- id: String
- isDarkMode: bool
- enableArchiveUrls: bool (デフォルトfalse)
- lastSyncDate: DateTime
- customThemeColor: String

## 6. データストレージ設計

### 6.1 SQLiteデータベース構造
- **テーブル構成**:
  - youtube_videos (id, video_id, title, published_at, thumbnail_path, description, video_url, archive_url, is_favorite, custom_notes)
  - tags (id, name, color)
  - video_tags (video_id, tag_id)
  - calendar_events (id, date)
  - event_videos (event_id, video_id)
  - favorites (video_id, added_at, custom_note)
  - app_settings (id, is_dark_mode, enable_archive_urls, last_sync_date, custom_theme_color)

### 6.2 ファイルストレージ
- **内部ストレージディレクトリ**:
  - `/data/user/0/[パッケージ名]/app_flutter/thumbnails/` - YouTubeサムネイル画像

### 6.3 初期データ
- アプリのアセットに含めるJSONファイル (`assets/data/initial_videos.json`)
- 初回起動時に自動的にローカルDBに展開
- データ更新はアプリアップデート時に実施

## 7. 共有機能

### 7.1 共有内容
- **サムネイル画像**: 内部ストレージから一時共有用にコピー
- **メッセージテキスト**: "YYYY/MM/DD にマール・アストレアさんが下記の配信をしました。{タイトル名}"
- **URL**: YouTube動画へのリンク（オプション）

## 8. 設定画面と隠し要素

### 8.1 基本設定
- キャッシュ消去オプション(ローカルデータベースのリセット機能)
- アプリバージョン表示

### 8.2 隠し要素：アーカイブ有効化
- **アクセス方法**: 設定画面のアプリバージョン表示を3回連続タップ
- **機能**: アーカイブURL表示の有効化/無効化トグル
- **デフォルト状態**: 無効（オフ）
- **効果**: 有効化時、動画詳細画面にアーカイブURLが表示される
- **永続化**: 設定はローカルDBに保存され、アプリ再起動後も維持

## 9. 内部ストレージ実装

- サムネイル画像は内部ストレージに保存
- ユーザーがファイルマネージャーから直接アクセスできない場所に保存
- アプリアンインストール時に自動的に削除される

## 10. 初期データロード実装

- 初回起動時にアセットから初期データを読み込む
- サムネイル画像も同時に内部ストレージにコピー
- 設定データのデフォルト値を作成

## 11. Material Design 3 の実装

- Material 3のコンポーネントを使用
- カスタムカラースキームの定義
- 角丸デザインの適用

## 12. 隠し要素（アーカイブ有効化）の実装

- バージョン表示の3回タップ検出
- 隠し設定画面の表示/非表示切り替え
- 設定変更の永続化
- 動画詳細画面での条件付き表示

## 13. 技術的課題と対策

### 13.1 画像管理
**課題**: サムネイルの内部ストレージへの効率的な保存と管理
**対策**:
- videoIdをベースにした一貫性のあるファイル命名
- メモリキャッシュの実装（CachedNetworkImage等の利用）
- 画像サイズの最適化と圧縮

### 13.2 検索パフォーマンス
**課題**: ローカルDBでの高速検索実現
**対策**:
- インデックスの最適化
- 全文検索実装
- クエリのキャッシュ

### 13.3 ストレージ容量
**課題**: アプリの内部ストレージ使用量の最適化
**対策**:
- 画像圧縮
- 不要データのクリーンアップオプション
- ストレージ使用量の可視化

## 14. UI/UXデザイン

### 14.1 カラーパレット
- **プライマリカラー**: 水色 (#A0E1F7)
- **セカンダリカラー**: 薄紫色 (#D8C9FF)
- **アクセントカラー**: 白 (#FFFFFF)
- **バックグラウンド**: 軽い青みがかった白 (#F5FAFF)
- **ダークモード**: 暗い紺色 (#191C1D) をベースにした配色

### 14.2 Material Design 3標準要素の活用
- Dynamic Color適用（ユーザーのシステムテーマが対応している場合）
- 角丸デザイン
- 新しいナビゲーションコンポーネント
- 大きめのタッチターゲット

### 14.3 アニメーション
- 画面遷移時の滑らかなアニメーション
- カレンダーの月切り替え時のページめくりエフェクト
- お気に入り追加時のハートアイコンアニメーション

## 15. 実装計画

### フェーズ1: 基盤開発（推定期間: 2週間）
- プロジェクト構造設定
- Material Design 3テーマ実装
- データモデル定義
- ローカルデータベース構築
- 内部ストレージ管理機能実装
- 初期データ作成と初期化処理

### フェーズ2: コア機能実装（推定期間: 2.5週間）
- ホーム画面
- カレンダー画面
- YouTube動画詳細画面
- 基本検索機能

### フェーズ3: 追加機能実装（推定期間: 1.5週間）
- 高度な検索・フィルタリング
- お気に入り機能
- 共有機能
- 設定画面
- アーカイブ隠し要素

### フェーズ4: テストと最適化（推定期間: 1週間）
- ユニットテスト
- UI/UXテスト
- パフォーマンス最適化
- ストレージ最適化

## 16. 必要なFlutterパッケージ

### UI関連
- table_calendar: カレンダー表示
- cached_network_image: 画像キャッシュ
- flutter_staggered_grid_view: グリッドレイアウト
- shimmer: ローディングエフェクト

### データ管理
- provider/riverpod: 状態管理
- drift/floor: SQLiteラッパー
- shared_preferences: 簡易データ保存
- hive: キャッシュ

### ファイル管理
- path_provider: アプリ内部ストレージへのアクセス
- file_picker: ファイル選択
- share_plus: シェア機能
- sqflite: SQLiteデータベース

### 機能関連
- url_launcher: 外部リンク（YouTubeアプリ起動）
- flutter_image_compress: 画像圧縮
- intl: 日付フォーマット

### 開発支援
- freezed: イミュータブルオブジェクト
- json_serializable: JSONシリアライズ
- flutter_lints: コーディング規約

## 17. CLINE開発準備

### コーディング規約
- 命名規則: lowerCamelCase（変数・メソッド）、UpperCamelCase（クラス）
- ファイル命名: snake_case.dart
- インデント: ソフトタブ 2スペース
- 最大行長: 80文字
- コメント: クラス・メソッド・複雑なロジックに必須

### モジュール分割
- core: 基盤機能
- data: データアクセス
- domain: ビジネスロジック
- presentation: UI層
- config: 設定
- utils: ユーティリティ

### CLINEプロンプト準備
- アプリ目的と機能の明確な説明
- モジュール構造の説明
- データモデルの明確な定義
- UI/UXのスタイルガイドライン
- ローカルデータ管理の詳細指示
- ブランド情報（イメージカラー）の説明
- 内部ストレージの使用方法
- 初期データのアセットからの読み込み方法
- Material Design 3の適用方法

## 18. 画面別UI設計

### 18.1 ホーム画面
- トップエリア: マール・アストレアのプロフィール情報
- 最近の動画: 水平スクロール式のカード表示
- 注目の動画: 大きめのサムネイルとタイトル表示
- 下部: Material Design 3ナビゲーションバー

### 18.2 カレンダー画面
- 月別カレンダー表示
- 活動日にはマーカー表示
- 選択日の動画一覧: 垂直スクロールリスト
- 動画カード: サムネイル、タイトル、日付

### 18.3 検索画面
- 上部: 検索バー（Material 3 SearchBar）
- フィルターオプション: タグ、日付範囲
- 検索結果: グリッドまたはリスト表示の切り替え
- 空の状態: 適切なメッセージと検索ヒント

### 18.4 お気に入り画面
- お気に入り一覧: グリッド表示
- 空の状態: お気に入り追加を促すメッセージ
- 編集モード: 選択削除機能

### 18.5 設定画面
- キャッシュ管理: 使用容量表示、クリアオプション
- アプリ情報: バージョン（隠し機能トリガー）
- 隠しアーカイブURL設定: バージョン3回タップで表示

### 18.6 動画詳細画面
- サムネイル表示（上部）
- タイトルと公開日
- 説明文（展開可能）
- アクションボタン: YouTube起動、お気に入り登録、共有
- アーカイブURL表示（条件付き）
- 関連動画セクション

## 19. データフロー

### 19.1 アプリ起動時
1. アプリ初期化
2. 初回起動チェック（SharedPreferences）
3. 初回起動時はアセットから初期データロード
4. DBと内部ストレージにデータを展開
5. テーマ設定とアプリ設定の読み込み
6. ホーム画面の表示

### 19.2 動画検索フロー
1. ユーザーが検索条件入力
2. 検索クエリをローカルDBに送信
3. DBからの結果を状態管理（Provider/Riverpod）で保持
4. UIに検索結果を表示
5. キャッシュ利用による高速表示

### 19.3 お気に入り機能フロー
1. ユーザーが動画をお気に入り登録
2. お気に入りステータスをDBに保存
3. お気に入り画面でリアルタイム反映

### 19.4 隠し機能アクセスフロー
1. ユーザーが設定画面でバージョン表示を3回タップ
2. 隠しアーカイブURL設定の表示
3. 設定変更時はDBに即座に保存
4. 動画詳細画面での条件付き表示

## 20. アプリケーションセキュリティ

### 20.1 データ保護
- 内部ストレージ利用によるサムネイル保護
- ユーザーデータのアプリ領域内保持
- 共有時の一時ファイル扱い

### 20.2 エラーハンドリング
- 初期データロード失敗時のフォールバック
- DB操作のトランザクション処理
- ファイル操作時の例外処理
- UIへのエラーメッセージ表示

### 20.3 バージョンアップ対応
- DBスキーマバージョン管理
- データマイグレーション対応
- 後方互換性の確保